<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0e1a">
<title>AADAmeet - Real-time Team Chat</title>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- Google Fonts: Geist Mono + DM Sans -->
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Geist+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Prism.js for Code Highlighting -->
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">

<style>
/* ============================================
   DESIGN SYSTEM: TERMINAL-NOIR / DEV-CORE
   Dark base, electric accents, mono precision
   ============================================ */
:root {
  --bg-0: #070b14;
  --bg-1: #0d1220;
  --bg-2: #111827;
  --bg-3: #1a2235;
  --bg-4: #222d42;
  --surface: #141c2e;
  --surface-2: #1e2a40;
  --surface-3: #263348;

  --accent: #00d4ff;
  --accent-dim: rgba(0, 212, 255, 0.15);
  --accent-glow: rgba(0, 212, 255, 0.25);
  --accent-2: #7c3aed;
  --accent-2-dim: rgba(124, 58, 237, 0.15);
  --green: #00ff94;
  --green-dim: rgba(0, 255, 148, 0.15);
  --amber: #ffb700;
  --amber-dim: rgba(255, 183, 0, 0.15);
  --red: #ff4757;
  --red-dim: rgba(255, 71, 87, 0.15);

  --text-0: #f0f4ff;
  --text-1: #a8b4cc;
  --text-2: #637089;
  --text-3: #3d4f6b;

  --border: rgba(0, 212, 255, 0.1);
  --border-2: rgba(0, 212, 255, 0.2);
  --border-hard: rgba(255, 255, 255, 0.06);

  --mono: 'Geist Mono', 'JetBrains Mono', monospace;
  --sans: 'DM Sans', system-ui, sans-serif;

  --radius-sm: 6px;
  --radius: 10px;
  --radius-lg: 16px;
  --radius-xl: 20px;

  --shadow-glow: 0 0 20px rgba(0, 212, 255, 0.15), 0 4px 24px rgba(0,0,0,0.4);
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
}

[data-theme="light"] {
  --bg-0: #f0f2f7;
  --bg-1: #e8eaf2;
  --bg-2: #eceef5;
  --bg-3: #dde0ed;
  --bg-4: #d0d3e4;
  --surface: #ffffff;
  --surface-2: #f4f5fb;
  --surface-3: #eaecf5;

  --accent: #2563eb;
  --accent-dim: rgba(37, 99, 235, 0.1);
  --accent-glow: rgba(37, 99, 235, 0.2);
  --accent-2: #7c3aed;
  --accent-2-dim: rgba(124, 58, 237, 0.1);
  --green: #059669;
  --green-dim: rgba(5, 150, 105, 0.1);
  --amber: #d97706;
  --amber-dim: rgba(217, 119, 6, 0.1);
  --red: #dc2626;
  --red-dim: rgba(220, 38, 38, 0.1);

  --text-0: #0f172a;
  --text-1: #334155;
  --text-2: #64748b;
  --text-3: #94a3b8;

  --border: rgba(37, 99, 235, 0.12);
  --border-2: rgba(37, 99, 235, 0.22);
  --border-hard: rgba(0, 0, 0, 0.07);

  --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.12), 0 4px 24px rgba(0,0,0,0.08);
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.1);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.14);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  overscroll-behavior-y: contain;
  height: 100%;
}

body {
  font-family: var(--sans);
  background: var(--bg-0);
  color: var(--text-0);
  min-height: 100vh;
  min-height: 100dvh;
  overflow: hidden;
  position: fixed;
  width: 100%;
  -webkit-font-smoothing: antialiased;
  touch-action: pan-y;
  overscroll-behavior: none;
  transition: background 0.3s, color 0.3s;
  cursor: default;
}

/* ── Grid background ─────────────────────────── */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(0,212,255,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,212,255,0.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
  transition: opacity 0.3s;
}

[data-theme="light"] body::before {
  background-image:
    linear-gradient(rgba(37,99,235,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(37,99,235,0.04) 1px, transparent 1px);
}

/* ── Ambient orbs ─────────────────────────────── */
.bg-orbs {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  overflow: hidden;
}

.bg-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(100px);
  opacity: 0.18;
  animation: orbDrift 30s ease-in-out infinite;
}

[data-theme="light"] .bg-orb { opacity: 0.12; }

.bg-orb:nth-child(1) {
  width: 600px; height: 600px;
  top: -20%; left: -10%;
  background: radial-gradient(circle, var(--accent), transparent 70%);
  animation-delay: 0s;
}
.bg-orb:nth-child(2) {
  width: 500px; height: 500px;
  top: 40%; right: -15%;
  background: radial-gradient(circle, var(--accent-2), transparent 70%);
  animation-delay: -10s;
}
.bg-orb:nth-child(3) {
  width: 400px; height: 400px;
  bottom: -10%; left: 35%;
  background: radial-gradient(circle, var(--green), transparent 70%);
  animation-delay: -20s;
  opacity: 0.1;
}

@keyframes orbDrift {
  0%, 100% { transform: translate(0,0) scale(1); }
  33% { transform: translate(50px,-50px) scale(1.1); }
  66% { transform: translate(-40px, 40px) scale(0.9); }
}

/* ── Container ───────────────────────────────── */
.container {
  position: relative;
  z-index: 1;
  width: 100%;
  max-width: 1600px;
  height: 100vh;
  height: 100dvh;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ═══════════════════════════════════════════════
   HEADER
═══════════════════════════════════════════════ */
.header {
  background: rgba(13, 18, 32, 0.92);
  backdrop-filter: blur(24px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-shrink: 0;
  position: relative;
  z-index: 10;
  box-shadow: 0 1px 0 var(--border-hard), var(--shadow-sm);
  animation: slideDown 0.4s cubic-bezier(0.16,1,0.3,1);
}

[data-theme="light"] .header {
  background: rgba(255,255,255,0.92);
}

@keyframes slideDown {
  from { transform: translateY(-100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.header-left {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  min-width: 0;
}

/* Logo mark */
.logo-mark {
  width: 34px;
  height: 34px;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 0 16px var(--accent-glow);
  position: relative;
  overflow: hidden;
}

.logo-mark::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
}

.logo-mark span {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 700;
  color: #fff;
  letter-spacing: -0.5px;
  position: relative;
}

.header-brand {
  display: flex;
  flex-direction: column;
  gap: 1px;
}

.brand-name {
  font-family: var(--mono);
  font-size: 15px;
  font-weight: 600;
  color: var(--text-0);
  letter-spacing: -0.5px;
  line-height: 1;
}

.brand-tagline {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--accent);
  letter-spacing: 0.5px;
  opacity: 0.7;
  line-height: 1;
}

/* Channel pill */
.channel-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  background: var(--accent-dim);
  border: 1px solid var(--border-2);
  border-radius: 100px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--accent);
  font-weight: 500;
  letter-spacing: 0.3px;
  white-space: nowrap;
}

.channel-pill .material-icons { font-size: 14px; }

.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}

/* Status badge */
.status-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 5px 10px;
  background: var(--bg-3);
  border: 1px solid var(--border-hard);
  border-radius: 6px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-2);
  transition: all 0.3s;
}

.status-badge.online {
  background: var(--green-dim);
  border-color: rgba(0,255,148,0.2);
  color: var(--green);
}

[data-theme="light"] .status-badge.online {
  color: var(--green);
}

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-2);
  transition: background 0.3s;
  flex-shrink: 0;
}

.status-dot.online {
  background: var(--green);
  box-shadow: 0 0 6px var(--green);
  animation: ping 2s ease-in-out infinite;
}

@keyframes ping {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Icon button (header buttons) */
.icon-btn {
  width: 34px;
  height: 34px;
  background: transparent;
  border: 1px solid var(--border-hard);
  border-radius: var(--radius-sm);
  color: var(--text-2);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}

.icon-btn:hover {
  background: var(--accent-dim);
  border-color: var(--border-2);
  color: var(--accent);
  box-shadow: 0 0 10px var(--accent-dim);
}

.icon-btn:active { transform: scale(0.92); }

.icon-btn .material-icons { font-size: 18px; }

/* Menu toggle (mobile) */
.menu-toggle {
  display: none;
  background: transparent;
  border: 1px solid var(--border-hard);
  border-radius: var(--radius-sm);
  color: var(--text-1);
  width: 34px;
  height: 34px;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}

.menu-toggle:hover {
  background: var(--accent-dim);
  border-color: var(--border-2);
  color: var(--accent);
}

.menu-toggle .material-icons { font-size: 20px; }

/* ═══════════════════════════════════════════════
   LOGIN SCREEN
═══════════════════════════════════════════════ */
.login-screen {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  position: relative;
}

/* Terminal scanline on login */
.login-screen::before {
  content: '';
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,212,255,0.012) 2px,
    rgba(0,212,255,0.012) 4px
  );
  pointer-events: none;
}

[data-theme="light"] .login-screen::before { opacity: 0; }

.login-card {
  background: var(--surface);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-xl);
  padding: 40px;
  width: 100%;
  max-width: 400px;
  box-shadow: var(--shadow-glow), var(--shadow-lg);
  position: relative;
  overflow: hidden;
  animation: cardReveal 0.6s cubic-bezier(0.16,1,0.3,1);
}

@keyframes cardReveal {
  from { opacity: 0; transform: translateY(24px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

/* Top accent stripe */
.login-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--green));
}

/* Corner decoration */
.login-card::after {
  content: '';
  position: absolute;
  bottom: -40px; right: -40px;
  width: 140px; height: 140px;
  border-radius: 50%;
  background: radial-gradient(circle, var(--accent-2), transparent 70%);
  opacity: 0.07;
  pointer-events: none;
}

.login-header {
  margin-bottom: 32px;
}

.login-eyebrow {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--accent);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.login-eyebrow::before {
  content: '';
  display: inline-block;
  width: 20px;
  height: 1px;
  background: var(--accent);
  opacity: 0.6;
}

.login-header h2 {
  font-size: 26px;
  font-weight: 700;
  color: var(--text-0);
  letter-spacing: -0.8px;
  line-height: 1.1;
  margin-bottom: 6px;
}

.login-header p {
  color: var(--text-2);
  font-size: 14px;
}

/* Input groups */
.input-group { margin-bottom: 16px; }

.input-label {
  display: block;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-2);
  letter-spacing: 0.8px;
  text-transform: uppercase;
  margin-bottom: 7px;
}

.input-wrapper { position: relative; }

.input-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-3);
  font-size: 18px;
  transition: color 0.2s;
  pointer-events: none;
}

input {
  width: 100%;
  padding: 12px 14px 12px 44px;
  background: var(--bg-2);
  border: 1px solid var(--border-hard);
  border-radius: var(--radius);
  color: var(--text-0);
  font-size: 14px;
  font-family: var(--sans);
  transition: all 0.2s;
  font-weight: 400;
  -webkit-appearance: none;
}

[data-theme="light"] input { background: var(--bg-1); }

input:focus {
  outline: none;
  border-color: var(--accent);
  background: var(--bg-1);
  box-shadow: 0 0 0 3px var(--accent-dim), 0 0 12px var(--accent-glow);
}

[data-theme="light"] input:focus { background: #fff; }

input:focus ~ .input-icon,
input:focus + .input-icon { color: var(--accent); }

input::placeholder { color: var(--text-3); }

/* Remember Me checkbox row */
.remember-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 24px;
  cursor: pointer;
  user-select: none;
}

.remember-checkbox {
  width: 16px !important;
  height: 16px !important;
  padding: 0 !important;
  flex-shrink: 0;
  accent-color: var(--accent);
  cursor: pointer;
  border-radius: 3px;
}

.remember-label {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-2);
  letter-spacing: 0.3px;
}

/* Login button */
.btn {
  width: 100%;
  padding: 13px;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  border: none;
  border-radius: var(--radius);
  color: #fff;
  font-size: 14px;
  font-weight: 600;
  font-family: var(--mono);
  letter-spacing: 0.5px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 16px var(--accent-glow), 0 0 30px var(--accent-dim);
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
  opacity: 0;
  transition: opacity 0.2s;
}

.btn:hover { transform: translateY(-1px); box-shadow: 0 6px 24px var(--accent-glow), 0 0 40px var(--accent-dim); }
.btn:hover::before { opacity: 1; }
.btn:active { transform: translateY(0); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* ═══════════════════════════════════════════════
   CHAT INTERFACE
═══════════════════════════════════════════════ */
.chat-interface {
  flex: 1;
  display: none;
  flex-direction: row;
  overflow: hidden;
  min-height: 0;
}

.chat-interface.active {
  display: flex;
  animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ── SIDEBAR ──────────────────────────────────── */
.sidebar {
  width: 260px;
  background: var(--bg-1);
  border-right: 1px solid var(--border-hard);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  transition: transform 0.3s cubic-bezier(0.16,1,0.3,1);
}

[data-theme="light"] .sidebar { background: var(--surface-2); }

.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border-hard);
  background: var(--bg-2);
}

[data-theme="light"] .sidebar-header { background: var(--surface-3); }

.sidebar-title-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.sidebar-title {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  color: var(--text-2);
  letter-spacing: 1.2px;
  text-transform: uppercase;
}

.online-badge {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  background: var(--green-dim);
  border: 1px solid rgba(0,255,148,0.2);
  border-radius: 100px;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--green);
  font-weight: 600;
}

.online-badge::before {
  content: '';
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 4px var(--green);
}

/* User profile card in sidebar header */
.sidebar-user-card {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--bg-3);
  border: 1px solid var(--border-hard);
  border-radius: var(--radius);
  cursor: default;
}

[data-theme="light"] .sidebar-user-card { background: var(--bg-0); }

.sidebar-user-avatar {
  width: 32px; height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--mono);
  font-weight: 700;
  font-size: 13px;
  color: #fff;
  flex-shrink: 0;
  border: 1px solid rgba(255,255,255,0.1);
}

.sidebar-user-info { flex: 1; min-width: 0; }

.sidebar-user-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-0);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1;
  margin-bottom: 2px;
}

.sidebar-user-you {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--accent);
  letter-spacing: 0.5px;
}

.user-list { flex: 1; overflow-y: auto; padding: 10px; }

.user-list-section-label {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 1px;
  color: var(--text-3);
  text-transform: uppercase;
  padding: 6px 8px 4px;
  font-weight: 600;
}

.user-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 10px;
  border-radius: var(--radius);
  margin-bottom: 2px;
  transition: all 0.15s;
  cursor: pointer;
  border: 1px solid transparent;
}

.user-item:hover {
  background: var(--accent-dim);
  border-color: var(--border);
}

.user-avatar {
  width: 36px; height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--mono);
  font-weight: 700;
  font-size: 14px;
  color: white;
  position: relative;
  flex-shrink: 0;
  border: 1px solid rgba(255,255,255,0.1);
}

.user-status {
  position: absolute;
  bottom: 0; right: 0;
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--text-3);
  border: 2px solid var(--bg-1);
  transition: background 0.3s;
}

[data-theme="light"] .user-status { border-color: var(--surface-2); }

.user-status.online {
  background: var(--green);
  box-shadow: 0 0 5px var(--green);
}

.user-info { flex: 1; min-width: 0; }

.user-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-0);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 1px;
}

.user-typing {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--accent);
  font-style: italic;
}

/* ── CHAT AREA ────────────────────────────────── */
.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg-0);
  min-height: 0;
  position: relative;
}

[data-theme="light"] .chat-area { background: var(--bg-2); }

/* Chat header strip */
.chat-area-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  height: 44px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border-hard);
  flex-shrink: 0;
}

[data-theme="light"] .chat-area-header { background: var(--surface); }

.chat-area-channel {
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-1);
}

.chat-area-channel .material-icons { font-size: 16px; color: var(--accent); }

.chat-area-actions { display: flex; align-items: center; gap: 6px; }

.chat-action-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  background: transparent;
  border: 1px solid var(--border-hard);
  border-radius: var(--radius-sm);
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-2);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
  letter-spacing: 0.3px;
  min-height: 30px;
  -webkit-tap-highlight-color: transparent;
}

.chat-action-pill .material-icons { font-size: 14px; }

.chat-action-pill:hover {
  background: var(--accent-dim);
  border-color: var(--border-2);
  color: var(--accent);
}

.chat-action-pill:active { transform: scale(0.95); }

/* Messages container */
.messages-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 20px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  min-height: 0;
  overscroll-behavior: contain;
}

/* Message groups */
.message {
  display: flex;
  gap: 10px;
  margin-bottom: 4px;
  animation: msgIn 0.25s cubic-bezier(0.16,1,0.3,1);
  position: relative;
}

.message.spaced { margin-top: 16px; }

@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.message.own { flex-direction: row-reverse; }

.message-avatar {
  width: 32px; height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--mono);
  font-weight: 700;
  font-size: 12px;
  color: white;
  flex-shrink: 0;
  border: 1px solid rgba(255,255,255,0.1);
  align-self: flex-end;
}

.message-avatar.hidden { visibility: hidden; }

.message-content {
  max-width: 68%;
  display: flex;
  flex-direction: column;
}

.message.own .message-content { align-items: flex-end; }

.message-header {
  display: flex;
  align-items: baseline;
  gap: 7px;
  margin-bottom: 4px;
  padding: 0 4px;
}

.message.own .message-header { flex-direction: row-reverse; }

.message-sender {
  font-family: var(--mono);
  font-weight: 600;
  font-size: 12px;
  color: var(--text-1);
  letter-spacing: 0.2px;
}

.message-time {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-3);
  font-weight: 400;
}

.message-bubble {
  background: var(--surface-2);
  padding: 10px 14px;
  border-radius: 2px 14px 14px 14px;
  border: 1px solid var(--border-hard);
  word-wrap: break-word;
  line-height: 1.6;
  font-size: 14px;
  transition: border-color 0.2s;
  position: relative;
}

[data-theme="light"] .message-bubble { background: var(--surface); }

.message-bubble:hover { border-color: var(--border); }

.message.own .message-bubble {
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  border: 1px solid transparent;
  color: white;
  border-radius: 14px 2px 14px 14px;
  box-shadow: 0 4px 16px var(--accent-glow);
}

.message.own .message-bubble:hover { box-shadow: 0 6px 24px var(--accent-glow); }

/* System message */
.system-message {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 12px 0;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-3);
  letter-spacing: 0.5px;
}

.system-message::before,
.system-message::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border-hard);
  max-width: 80px;
}

/* Typing indicator */
.typing-indicator {
  display: flex;
  gap: 10px;
  margin-bottom: 8px;
  margin-top: 8px;
  align-items: flex-end;
}

.typing-dots {
  background: var(--surface-2);
  border: 1px solid var(--border-hard);
  padding: 10px 14px;
  border-radius: 2px 14px 14px 14px;
  display: flex;
  gap: 4px;
  align-items: center;
}

[data-theme="light"] .typing-dots { background: var(--surface); }

.typing-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--accent);
  opacity: 0.5;
  animation: typingBounce 1.4s ease-in-out infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
  30% { transform: translateY(-6px); opacity: 1; }
}

/* ── MESSAGE INPUT AREA ──────────────────────── */
.message-input-area {
  padding: 12px 16px;
  padding-bottom: calc(12px + env(safe-area-inset-bottom));
  background: var(--bg-1);
  border-top: 1px solid var(--border-hard);
  flex-shrink: 0;
  transition: all 0.3s;
}

[data-theme="light"] .message-input-area { background: var(--surface); }

.input-toolbar {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
  overflow-x: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
  align-items: center;
}

.input-toolbar::-webkit-scrollbar { display: none; }

.toolbar-divider {
  width: 1px;
  height: 20px;
  background: var(--border-hard);
  flex-shrink: 0;
}

.message-input-row {
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

/* Textarea */
#messageInput {
  flex: 1;
  padding: 11px 14px;
  background: var(--bg-2);
  border: 1px solid var(--border-hard);
  border-radius: var(--radius);
  color: var(--text-0);
  font-size: 14px;
  font-family: var(--sans);
  resize: none;
  max-height: 120px;
  min-height: 44px;
  transition: all 0.2s;
  line-height: 1.55;
  font-weight: 400;
}

[data-theme="light"] #messageInput { background: var(--bg-0); border-color: var(--border-hard); }

#messageInput:focus {
  outline: none;
  border-color: var(--accent);
  background: var(--bg-3);
  box-shadow: 0 0 0 2px var(--accent-dim);
}

[data-theme="light"] #messageInput:focus { background: #fff; }

#messageInput::placeholder { color: var(--text-3); }

/* Send button */
.send-btn {
  width: 44px; height: 44px;
  min-width: 44px;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  border: none;
  border-radius: var(--radius);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  box-shadow: 0 4px 12px var(--accent-glow);
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
}

.send-btn:hover { transform: scale(1.06); box-shadow: 0 6px 20px var(--accent-glow); }
.send-btn:active { transform: scale(0.93); }

.send-btn .material-icons { font-size: 20px; }

/* Char counter */
.char-counter {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-3);
  align-self: flex-end;
  padding-bottom: 13px;
  min-width: 32px;
  text-align: right;
}

/* ── SCROLLBAR ───────────────────────────────── */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg-4); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }

/* ═══════════════════════════════════════════════
   NOTIFICATION TOAST
═══════════════════════════════════════════════ */
.toast {
  position: fixed;
  top: 68px;
  right: 16px;
  background: var(--surface);
  border: 1px solid var(--border-hard);
  color: var(--text-0);
  padding: 10px 14px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  border-left: 2px solid var(--accent);
  display: flex;
  align-items: center;
  gap: 8px;
  animation: toastIn 0.3s cubic-bezier(0.16,1,0.3,1);
  z-index: 1000;
  max-width: 300px;
  font-size: 13px;
  font-family: var(--mono);
}

@keyframes toastIn {
  from { transform: translateX(120%) scale(0.9); opacity: 0; }
  to { transform: translateX(0) scale(1); opacity: 1; }
}

.toast .material-icons { font-size: 16px; flex-shrink: 0; }

.toast.error { border-left-color: var(--red); }
.toast.error .material-icons { color: var(--red); }
.toast.success { border-left-color: var(--green); }
.toast.success .material-icons { color: var(--green); }

/* ═══════════════════════════════════════════════
   LOADING INDICATOR
═══════════════════════════════════════════════ */
.loading-indicator {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: var(--surface);
  border: 1px solid var(--border-2);
  padding: 28px 36px;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-glow), var(--shadow-lg);
  z-index: 9999;
  display: none;
  text-align: center;
  min-width: 200px;
}

.loading-indicator.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

.loading-spinner {
  width: 40px; height: 40px;
  border: 2px solid var(--border-hard);
  border-top-color: var(--accent);
  border-right-color: var(--accent-2);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  margin: 0 auto 14px;
}

.loading-spinner.sm {
  width: 24px; height: 24px;
  margin: 0 auto;
  border-width: 2px;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-2);
  letter-spacing: 0.5px;
}

.loading-dots::after {
  content: '';
  animation: loadDots 1.2s steps(4) infinite;
}

@keyframes loadDots {
  0% { content: ''; }
  25% { content: '.'; }
  50% { content: '..'; }
  75% { content: '...'; }
}

/* ═══════════════════════════════════════════════
   LINK MODAL
═══════════════════════════════════════════════ */
.link-modal {
  position: fixed;
  inset: 0;
  background: rgba(7, 11, 20, 0.8);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

.link-modal.active { display: flex; }

.link-modal-content {
  background: var(--surface);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-lg);
  padding: 24px;
  max-width: 460px;
  width: 100%;
  box-shadow: var(--shadow-glow), var(--shadow-lg);
  animation: modalIn 0.3s cubic-bezier(0.16,1,0.3,1);
  position: relative;
}

@keyframes modalIn {
  from { transform: scale(0.92) translateY(20px); opacity: 0; }
  to { transform: scale(1) translateY(0); opacity: 1; }
}

.link-modal-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
  padding-bottom: 14px;
  border-bottom: 1px solid var(--border-hard);
}

.link-modal-header .material-icons { font-size: 22px; color: var(--accent); }
.link-modal-header h3 { font-size: 16px; font-weight: 600; flex: 1; }

.link-modal-close {
  width: 28px; height: 28px;
  background: var(--bg-3);
  border: 1px solid var(--border-hard);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s;
  color: var(--text-2);
}

.link-modal-close:hover { background: var(--red-dim); border-color: var(--red); color: var(--red); }
.link-modal-close .material-icons { font-size: 16px; }

.link-url {
  background: var(--bg-2);
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  word-break: break-all;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-2);
  border: 1px solid var(--border-hard);
}

.link-modal-actions { display: flex; gap: 10px; }

.link-modal-btn {
  flex: 1;
  padding: 10px 14px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  transition: all 0.2s;
  letter-spacing: 0.3px;
}

.link-modal-btn.primary {
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  color: white;
  box-shadow: 0 4px 12px var(--accent-glow);
}

.link-modal-btn.primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px var(--accent-glow); }

.link-modal-btn.secondary {
  background: var(--bg-3);
  color: var(--text-1);
  border: 1px solid var(--border-hard);
}

.link-modal-btn.secondary:hover { background: var(--bg-4); }
.link-modal-btn:active { transform: scale(0.96); }
.link-modal-btn .material-icons { font-size: 16px; }

/* Checking state */
.link-modal-checking {
  text-align: center;
  padding: 20px;
}

.link-modal-checking p {
  color: var(--text-2);
  font-family: var(--mono);
  font-size: 12px;
  margin-bottom: 8px;
}

.link-being-checked {
  font-size: 11px;
  color: var(--text-3);
  word-break: break-all;
  font-family: var(--mono);
  background: var(--bg-2);
  padding: 8px;
  border-radius: var(--radius-sm);
  margin-top: 10px;
  border: 1px solid var(--border-hard);
}

/* Result states */
.link-result {
  padding: 14px;
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.link-result.safe { background: var(--green-dim); border: 1px solid rgba(0,255,148,0.2); }
.link-result.unsafe { background: var(--red-dim); border: 1px solid rgba(255,71,87,0.2); }

.link-result .material-icons { font-size: 22px; flex-shrink: 0; }
.link-result.safe .material-icons { color: var(--green); }
.link-result.unsafe .material-icons { color: var(--red); }

.link-result-content h4 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
.link-result-content p { font-size: 12px; color: var(--text-2); line-height: 1.5; }

.link-result-stats {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--border-hard);
  display: flex;
  gap: 14px;
  font-family: var(--mono);
  font-size: 11px;
}

.link-result-stat { display: flex; align-items: center; gap: 4px; color: var(--text-2); }
.link-result-stat .material-icons { font-size: 14px; }
.link-result-stat.malicious { color: var(--red); }
.link-result-stat.clean { color: var(--green); }

/* ═══════════════════════════════════════════════
   CODE BLOCKS
═══════════════════════════════════════════════ */
.code-block-container {
  background: var(--bg-0);
  border: 1px solid var(--border-hard);
  border-radius: var(--radius);
  margin: 8px 0;
  overflow: hidden;
  max-width: 100%;
}

[data-theme="light"] .code-block-container { background: #f6f8fa; }

.message-content .code-block-container { margin: 0; }
.message-content:has(.code-block-container) { max-width: 90% !important; }
.message.own .message-content:has(.code-block-container) { max-width: 90% !important; }
.message.own .code-block-container { border: 1px solid var(--border-hard); }

.code-block-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border-hard);
}

[data-theme="light"] .code-block-header { background: var(--bg-3); }

.code-block-lang {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  color: var(--accent);
  letter-spacing: 0.8px;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 6px;
}

.code-block-lang .material-icons { font-size: 14px; }
.code-block-actions { display: flex; gap: 5px; }

.code-action-btn {
  background: transparent;
  border: 1px solid var(--border-hard);
  color: var(--text-2);
  padding: 3px 8px;
  border-radius: var(--radius-sm);
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: all 0.15s;
  letter-spacing: 0.3px;
}

.code-action-btn:hover { background: var(--accent-dim); border-color: var(--border-2); color: var(--accent); }
.code-action-btn .material-icons { font-size: 14px; }

.code-action-btn.run-btn {
  background: var(--green-dim);
  border-color: rgba(0,255,148,0.2);
  color: var(--green);
}

.code-action-btn.run-btn:hover { background: rgba(0,255,148,0.25); box-shadow: 0 0 10px var(--green-dim); }

.code-block-content { position: relative; max-height: 360px; overflow: auto; }
.code-block-content pre { margin: 0; padding: 14px; background: transparent !important; font-family: var(--mono); font-size: 12.5px; line-height: 1.65; overflow-x: auto; }
.code-block-content code { font-family: var(--mono); }

/* ═══════════════════════════════════════════════
   CODE PREVIEW PANEL
═══════════════════════════════════════════════ */
.code-preview-panel {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--surface);
  border-top: 1px solid var(--border-2);
  box-shadow: 0 -8px 32px rgba(0,0,0,0.5);
  z-index: 1500;
  display: none;
  flex-direction: column;
  animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1);
  height: 40vh;
  min-height: 200px;
  max-height: 80vh;
  overflow: hidden;
}

.code-preview-panel.active { display: flex; }

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.preview-resize-handle {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 6px;
  cursor: ns-resize;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
}

.preview-resize-handle::before {
  content: '';
  width: 36px; height: 3px;
  background: var(--border-hard);
  border-radius: 2px;
  transition: all 0.2s;
}

.preview-resize-handle:hover::before { background: var(--accent); width: 56px; }

.preview-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border-hard);
  flex-shrink: 0;
}

[data-theme="light"] .preview-header { background: var(--surface-2); }

.preview-header h3 {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-1);
  display: flex;
  align-items: center;
  gap: 7px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.preview-header .material-icons { font-size: 16px; color: var(--green); }
.preview-actions { display: flex; gap: 6px; }

.preview-btn {
  background: transparent;
  border: 1px solid var(--border-hard);
  color: var(--text-2);
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: all 0.15s;
  letter-spacing: 0.3px;
}

.preview-btn:hover { background: var(--bg-3); color: var(--text-1); }
.preview-btn .material-icons { font-size: 14px; }

.preview-content { flex: 1; overflow: hidden; position: relative; min-height: 0; }
.preview-iframe { width: 100%; height: 100%; border: none; background: white; }

/* ═══════════════════════════════════════════════
   LINK IN MESSAGES
═══════════════════════════════════════════════ */
.message-bubble a {
  color: var(--accent);
  text-decoration: none;
  border-bottom: 1px solid var(--border-2);
  font-weight: 500;
  cursor: pointer;
  word-break: break-all;
  transition: opacity 0.15s;
  font-family: var(--mono);
  font-size: 0.9em;
}

.message.own .message-bubble a { color: rgba(255,255,255,0.9); border-bottom-color: rgba(255,255,255,0.3); }
.message-bubble a:hover { opacity: 0.75; }

/* ═══════════════════════════════════════════════
   MOBILE RESPONSIVE
═══════════════════════════════════════════════ */
@media (max-width: 768px) {
  .channel-pill { display: none; }
  .brand-tagline { display: none; }

  .header { padding: 0 14px; }
  .menu-toggle { display: flex; }

  .sidebar {
    position: fixed;
    left: 0; top: 0;
    height: 100%; height: 100dvh;
    z-index: 200;
    transform: translateX(-100%);
    box-shadow: var(--shadow-lg);
    width: 260px;
  }

  .sidebar.open { transform: translateX(0); }

  .sidebar.open::after {
    content: '';
    position: fixed;
    top: 0; left: 260px; right: 0; bottom: 0;
    background: rgba(7,11,20,0.6);
    backdrop-filter: blur(4px);
    z-index: -1;
  }

  .messages-container { padding: 14px; }
  .chat-area-header { padding: 0 14px; }
  .message-content { max-width: 82%; }
  .message-input-area { padding: 10px 14px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }

  .chat-action-pill span:not(.material-icons) { display: none; }
  .chat-action-pill { padding: 5px 8px; }

  .toast { top: 68px; right: 12px; left: 12px; max-width: calc(100% - 24px); }
}

@media (max-width: 480px) {
  .header-brand { display: none; }
  .status-badge span:last-child { display: none; }
  .message-content { max-width: 88%; }
  .char-counter { display: none; }
}

@media (max-width: 900px) and (max-height: 500px) {
  .header { height: 48px; }
  .messages-container { padding: 10px; }
  .message-input-area { padding: 8px 12px; }
}

/* iOS fix */
@supports (-webkit-touch-callout: none) {
  input, textarea, select { font-size: 16px !important; }
}

/* Tap highlight */
* { -webkit-tap-highlight-color: transparent; }
button { -webkit-tap-highlight-color: var(--accent-dim); }

input:focus, textarea:focus { transform: scale(1); }
</style>
</head>

<body>
<!-- Ambient background -->
<div class="bg-orbs" aria-hidden="true">
  <div class="bg-orb"></div>
  <div class="bg-orb"></div>
  <div class="bg-orb"></div>
</div>

<div class="container">

  <!-- ── HEADER ─────────────────────────────── -->
  <header class="header">
    <div class="header-left">
      <button class="menu-toggle" id="menuToggle" aria-label="Toggle sidebar">
        <span class="material-icons">menu</span>
      </button>
      <div class="logo-mark">
        <span>AM</span>
      </div>
      <div class="header-brand">
        <span class="brand-name">AADAmeet</span>
        <span class="brand-tagline">real-time · mqtt</span>
      </div>
      <div class="channel-pill">
        <span class="material-icons">tag</span>
        hall/msg1
      </div>
    </div>

    <div class="header-right">
      <div class="status-badge" id="statusBadge">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Offline</span>
      </div>
      <button class="icon-btn" id="themeToggle" title="Toggle theme">
        <span class="material-icons">dark_mode</span>
      </button>
    </div>
  </header>

  <!-- ── LOGIN SCREEN ───────────────────────── -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-header">
        <div class="login-eyebrow">secure access</div>
        <h2>Sign in to<br>AADAmeet</h2>
        <p>Connect to your team's real-time workspace</p>
      </div>

      <form id="loginForm" autocomplete="on">
        <div class="input-group">
          <label class="input-label" for="displayName">Display Name</label>
          <div class="input-wrapper">
            <input type="text" id="displayName" name="displayName" placeholder="Your name in chat" autocomplete="name" required>
            <span class="material-icons input-icon">person</span>
          </div>
        </div>
        <div class="input-group">
          <label class="input-label" for="username">Username</label>
          <div class="input-wrapper">
            <input type="text" id="username" name="username" placeholder="MQTT username" autocomplete="username" required>
            <span class="material-icons input-icon">account_circle</span>
          </div>
        </div>
        <div class="input-group">
          <label class="input-label" for="password">Password</label>
          <div class="input-wrapper">
            <input type="password" id="password" name="password" placeholder="MQTT password" autocomplete="current-password" required>
            <span class="material-icons input-icon">lock</span>
          </div>
        </div>

        <label class="remember-row">
          <input type="checkbox" id="rememberMeCheck" class="remember-checkbox">
          <span class="remember-label">Remember me on this device</span>
        </label>

        <button type="submit" class="btn" id="loginBtn">
          Connect
        </button>
      </form>
    </div>
  </div>

  <!-- ── CHAT INTERFACE ─────────────────────── -->
  <div class="chat-interface" id="chatInterface">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title-row">
          <span class="sidebar-title">Members</span>
          <span class="online-badge" id="onlineCount">0</span>
        </div>
        <div class="sidebar-user-card" id="sidebarUserCard" style="display:none">
          <div class="sidebar-user-avatar" id="sidebarUserAvatar">?</div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name" id="sidebarUserName">—</div>
            <div class="sidebar-user-you">you</div>
          </div>
        </div>
      </div>
      <div class="user-list" id="userList">
        <div class="user-list-section-label">Online</div>
      </div>
    </aside>

    <!-- Chat area -->
    <main class="chat-area">
      <!-- Sub-header -->
      <div class="chat-area-header">
        <div class="chat-area-channel">
          <span class="material-icons">tag</span>
          general
        </div>
        <div class="chat-area-actions" id="chatAreaActions">
          <button class="chat-action-pill" id="clearBtn">
            <span class="material-icons">delete_outline</span>
            <span>Clear</span>
          </button>
          <button class="chat-action-pill" id="notifBtn">
            <span class="material-icons" id="notifIcon">notifications</span>
            <span>Notifs</span>
          </button>
          <button class="chat-action-pill" id="rememberMeBtn" title="Remember Me">
            <span class="material-icons" id="rememberMeIcon">bookmark_border</span>
            <span>Remember</span>
          </button>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages-container" id="messagesContainer"></div>

      <!-- Input area -->
      <div class="message-input-area">
        <div class="input-toolbar" id="inputToolbar">
          <!-- Toolbar is intentionally minimal; action pills moved to chat header -->
        </div>
        <div class="message-input-row">
          <textarea
            id="messageInput"
            placeholder="Message #general  ·  Shift+Enter for new line"
            rows="1"
            aria-label="Message input"
          ></textarea>
          <span class="char-counter" id="charCounter">0</span>
          <button class="send-btn" id="sendBtn" aria-label="Send message">
            <span class="material-icons">send</span>
          </button>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ── CODE PREVIEW PANEL ────────────────── -->
<div class="code-preview-panel" id="codePreviewPanel">
  <div class="preview-resize-handle" id="previewResizeHandle"></div>
  <div class="preview-header">
    <h3>
      <span class="material-icons">play_circle</span>
      Live Preview
    </h3>
    <div class="preview-actions">
      <button class="preview-btn" id="clearPreviewBtn">
        <span class="material-icons">refresh</span>
        <span>Clear</span>
      </button>
      <button class="preview-btn" id="closePreviewBtn">
        <span class="material-icons">close</span>
        <span>Close</span>
      </button>
    </div>
  </div>
  <div class="preview-content">
    <iframe
      id="previewIframe"
      class="preview-iframe"
      sandbox="allow-scripts allow-same-origin"
      title="Code Preview">
    </iframe>
  </div>
</div>

<!-- ── LINK MODAL ─────────────────────────── -->
<div class="link-modal" id="linkModal" role="dialog" aria-modal="true">
  <div class="link-modal-content" id="linkModalContent">
    <div class="link-modal-header">
      <span class="material-icons">link</span>
      <h3>Open Link</h3>
      <div class="link-modal-close" id="linkModalClose" role="button" tabindex="0" aria-label="Close">
        <span class="material-icons">close</span>
      </div>
    </div>
    <div id="linkModalBody"></div>
  </div>
</div>

<!-- ── LOADING INDICATOR ──────────────────── -->
<div class="loading-indicator" id="loadingIndicator" role="status" aria-live="polite">
  <div class="loading-spinner"></div>
  <div class="loading-text">Connecting<span class="loading-dots"></span></div>
</div>

<!-- ── SCRIPTS ─────────────────────────────── -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 AADAmeet initializing...');

  // ── THEME ──────────────────────────────────────
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = themeToggle.querySelector('.material-icons');

  const currentTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', currentTheme);
  updateThemeIcon(currentTheme);

  themeToggle.addEventListener('click', function() {
    const theme = document.documentElement.getAttribute('data-theme');
    const newTheme = theme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
    this.style.transform = 'rotate(180deg) scale(0.9)';
    setTimeout(() => { this.style.transform = ''; }, 300);
  });

  function updateThemeIcon(theme) {
    themeIcon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
  }

  // ── REMEMBER ME ────────────────────────────────
  function saveCredentials(displayName, username, password) {
    localStorage.setItem('rememberMe', 'true');
    localStorage.setItem('savedDisplayName', displayName);
    localStorage.setItem('savedUsername', username);
    localStorage.setItem('savedPassword', password);
  }

  function clearSavedCredentials() {
    localStorage.removeItem('rememberMe');
    localStorage.removeItem('savedDisplayName');
    localStorage.removeItem('savedUsername');
    localStorage.removeItem('savedPassword');
  }

  function isRememberMeEnabled() {
    return localStorage.getItem('rememberMe') === 'true';
  }

  function updateRememberMeIcon() {
    const icon = document.getElementById('rememberMeIcon');
    if (icon) icon.textContent = isRememberMeEnabled() ? 'bookmark' : 'bookmark_border';
    // Also tint if active
    const btn = document.getElementById('rememberMeBtn');
    if (btn) {
      btn.style.color = isRememberMeEnabled() ? 'var(--accent)' : '';
      btn.style.borderColor = isRememberMeEnabled() ? 'var(--border-2)' : '';
      btn.style.background = isRememberMeEnabled() ? 'var(--accent-dim)' : '';
    }
  }

  function attemptAutoLogin() {
    if (!isRememberMeEnabled()) return;
    const d = localStorage.getItem('savedDisplayName') || '';
    const u = localStorage.getItem('savedUsername') || '';
    const p = localStorage.getItem('savedPassword') || '';
    if (!d || !u || !p) return;
    document.getElementById('displayName').value = d;
    document.getElementById('username').value = u;
    document.getElementById('password').value = p;
    document.getElementById('rememberMeCheck').checked = true;
    connectToMQTT(d, u, p);
  }

  updateRememberMeIcon();

  // ── CONFIG ─────────────────────────────────────
  const BROKER = "wss://a8e22050b9054b32ab8a6ab0c505d814.s1.eu.hivemq.cloud:8884/mqtt";
  const CHAT_TOPIC = "hall/msg1";
  const PRESENCE_TOPIC = "hall/presence";
  const TYPING_TOPIC = "hall/typing";
  const DEBUG_MODE = true;

  const API_CONFIG = {
    baseUrl: 'https://pybackend-aadameet1.onrender.com',
    endpoint: '/check-url',
    method: 'POST'
  };

  // ── STATE ──────────────────────────────────────
  let client = null;
  let currentUser = null;
  let users = new Map();
  let typingUsers = new Set();
  let typingTimeout = null;
  let notificationsEnabled = true;
  let lastSenderId = null; // for message grouping

  // ── UTILITIES ──────────────────────────────────
  function generateUserId() {
    return 'u_' + Math.random().toString(36).substr(2, 9);
  }

  const AVATAR_COLORS = [
    'linear-gradient(135deg,#00b4db,#0083b0)',
    'linear-gradient(135deg,#7c3aed,#a855f7)',
    'linear-gradient(135deg,#059669,#10b981)',
    'linear-gradient(135deg,#ea580c,#f97316)',
    'linear-gradient(135deg,#0ea5e9,#38bdf8)',
    'linear-gradient(135deg,#db2777,#ec4899)',
    'linear-gradient(135deg,#d97706,#fbbf24)',
    'linear-gradient(135deg,#dc2626,#ef4444)'
  ];

  function generateColor(name) {
    const index = name.charCodeAt(0) % AVATAR_COLORS.length;
    return AVATAR_COLORS[index];
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showToast(message, type = 'info') {
    // Remove existing toasts
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = { error: 'error_outline', success: 'check_circle_outline', info: 'info_outline' };
    toast.innerHTML = `<span class="material-icons">${icons[type] || 'info_outline'}</span><span>${message}</span>`;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(120%)';
      toast.style.transition = 'all 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function updateConnectionStatus(connected) {
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('statusText');
    const badge = document.getElementById('statusBadge');
    if (connected) {
      dot.classList.add('online');
      text.textContent = 'Connected';
      badge.classList.add('online');
    } else {
      dot.classList.remove('online');
      text.textContent = 'Offline';
      badge.classList.remove('online');
    }
  }

  function addSystemMessage(text) {
    const container = document.getElementById('messagesContainer');
    const el = document.createElement('div');
    el.className = 'system-message';
    el.innerHTML = `<span>${escapeHtml(text)}</span>`;
    container.appendChild(el);
    container.scrollTop = container.scrollHeight;
    lastSenderId = null;
  }

  function addMessage(data, isOwn = false) {
    const container = document.getElementById('messagesContainer');
    const msgDiv = document.createElement('div');
    const isSameAsPrevious = lastSenderId === data.userId;
    msgDiv.className = `message ${isOwn ? 'own' : ''} ${!isSameAsPrevious ? 'spaced' : ''}`;
    lastSenderId = data.userId;

    const time = new Date(data.timestamp).toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit'
    });

    const messageText = linkifyMessage(data.message);
    const avatarHidden = isSameAsPrevious ? 'hidden' : '';
    const headerHidden = isSameAsPrevious ? 'style="display:none"' : '';

    msgDiv.innerHTML = `
      <div class="message-avatar ${avatarHidden}" style="background: ${data.color || (currentUser && currentUser.color)}">
        ${isSameAsPrevious ? '' : (data.avatar || (currentUser && currentUser.avatar))}
      </div>
      <div class="message-content">
        <div class="message-header" ${headerHidden}>
          <span class="message-sender">${isOwn ? (currentUser ? currentUser.name : 'You') : data.name}</span>
          <span class="message-time">${time}</span>
        </div>
        <div class="message-bubble">${messageText}</div>
      </div>
    `;

    container.appendChild(msgDiv);

    if (typeof Prism !== 'undefined') {
      msgDiv.querySelectorAll('code[class*="language-"]').forEach(b => Prism.highlightElement(b));
    }

    msgDiv.querySelectorAll('.message-bubble a.message-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        showLinkModal(this.getAttribute('href'));
      });
    });

    container.scrollTop = container.scrollHeight;
  }

  function linkifyMessage(text) {
    const codeBlockMatch = text.match(/```(\w+)?\n?([\s\S]*?)```/);
    if (codeBlockMatch) {
      const lang = codeBlockMatch[1] || 'html';
      const code = codeBlockMatch[2].trim();
      return renderCodeBlock(lang, code);
    }
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    const escapedText = escapeHtml(text);
    return escapedText.replace(urlRegex, url => `<a href="${url}" class="message-link">${url}</a>`);
  }

  function renderCodeBlock(lang, code) {
    const codeId = 'code_' + Math.random().toString(36).substr(2, 9);
    const escapedCode = escapeHtml(code);
    const encodedCode = btoa(encodeURIComponent(code));
    const icons = { html: 'html', markup: 'html', css: 'style', javascript: 'javascript', js: 'javascript' };
    const icon = icons[lang] || 'code';
    return `
      <div class="code-block-container">
        <div class="code-block-header">
          <div class="code-block-lang">
            <span class="material-icons">${icon}</span>
            <span>${lang.toUpperCase()}</span>
          </div>
          <div class="code-block-actions">
            <button class="code-action-btn" onclick="copyCode('${codeId}')">
              <span class="material-icons">content_copy</span>
              <span>Copy</span>
            </button>
            <button class="code-action-btn run-btn" onclick="runCode('${encodedCode}')">
              <span class="material-icons">play_arrow</span>
              <span>Run</span>
            </button>
          </div>
        </div>
        <div class="code-block-content">
          <pre><code id="${codeId}" class="language-${lang}">${escapedCode}</code></pre>
        </div>
      </div>`;
  }

  window.runCode = function(encodedCode) {
    try {
      const code = decodeURIComponent(atob(encodedCode));
      const previewPanel = document.getElementById('codePreviewPanel');
      const previewIframe = document.getElementById('previewIframe');
      previewIframe.srcdoc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{margin:0;padding:16px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}</style></head><body>${code}</body></html>`;
      previewPanel.classList.add('active');
      showToast('Code executed successfully', 'success');
    } catch (e) {
      showToast('Error running code', 'error');
    }
  };

  window.copyCode = function(codeId) {
    const el = document.getElementById(codeId);
    navigator.clipboard.writeText(el.textContent).then(() => {
      showToast('Copied to clipboard', 'success');
    }).catch(() => showToast('Failed to copy', 'error'));
  };

  function updateUserList() {
    const userList = document.getElementById('userList');
    userList.innerHTML = '<div class="user-list-section-label">Online</div>';
    let onlineCount = 0;

    users.forEach(user => {
      if (user.online) onlineCount++;
      const userDiv = document.createElement('div');
      userDiv.className = 'user-item';
      userDiv.innerHTML = `
        <div class="user-avatar" style="background:${user.color}">
          ${user.avatar}
          <span class="user-status ${user.online ? 'online' : ''}"></span>
        </div>
        <div class="user-info">
          <div class="user-name">${user.name}</div>
        </div>`;
      userList.appendChild(userDiv);
    });

    document.getElementById('onlineCount').textContent = onlineCount;
  }

  // ── LOGIN ───────────────────────────────────────
  function connectToMQTT(displayName, username, password) {
    if (typeof mqtt === 'undefined') {
      showToast('MQTT library not loaded. Refresh the page.', 'error');
      console.error('❌ MQTT library not loaded');
      return;
    }

    if (DEBUG_MODE) {
      console.log('=== AADAmeet Debug ===');
      console.log('Broker:', BROKER);
      console.log('Username:', username);
      console.log('Display Name:', displayName);
    }

    const loginBtn = document.getElementById('loginBtn');
    loginBtn.disabled = true;
    loginBtn.textContent = 'Connecting...';
    document.getElementById('loadingIndicator').classList.add('active');

    currentUser = {
      id: generateUserId(),
      name: displayName,
      avatar: displayName.charAt(0).toUpperCase(),
      color: generateColor(displayName)
    };

    // Update sidebar user card
    document.getElementById('sidebarUserAvatar').textContent = currentUser.avatar;
    document.getElementById('sidebarUserAvatar').style.background = currentUser.color;
    document.getElementById('sidebarUserName').textContent = currentUser.name;
    document.getElementById('sidebarUserCard').style.display = 'flex';

    const clientId = `teamchat_${currentUser.id}_${Date.now()}`;
    if (DEBUG_MODE) console.log('Client ID:', clientId);

    try {
      client = mqtt.connect(BROKER, {
        clientId,
        username,
        password,
        keepalive: 60,
        clean: true,
        reconnectPeriod: 5000,
        connectTimeout: 30000,
        will: {
          topic: PRESENCE_TOPIC,
          payload: JSON.stringify({ userId: currentUser.id, name: currentUser.name, status: 'offline', timestamp: Date.now() }),
          qos: 1,
          retain: true
        }
      });

      client.on('connect', handleConnect);
      client.on('message', handleMessage);
      client.on('error', handleError);
      client.on('offline', handleOffline);
      client.on('reconnect', handleReconnect);
    } catch (error) {
      console.error('❌ Connection error:', error);
      showToast('Failed to connect: ' + error.message, 'error');
      loginBtn.disabled = false;
      loginBtn.textContent = 'Connect';
      document.getElementById('loadingIndicator').classList.remove('active');
    }
  }

  document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const displayName = document.getElementById('displayName').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    if (!displayName || !username || !password) {
      showToast('Please fill in all fields', 'error');
      return;
    }

    const rememberMe = document.getElementById('rememberMeCheck').checked;
    if (rememberMe) {
      saveCredentials(displayName, username, password);
    } else {
      clearSavedCredentials();
    }
    updateRememberMeIcon();
    connectToMQTT(displayName, username, password);
  });

  // Auto-login after MQTT lib loads
  function waitForMQTTAndAutoLogin() {
    if (typeof mqtt !== 'undefined') {
      attemptAutoLogin();
    } else {
      setTimeout(waitForMQTTAndAutoLogin, 100);
    }
  }
  waitForMQTTAndAutoLogin();

  // ── HANDLERS ───────────────────────────────────
  function handleConnect() {
    if (DEBUG_MODE) console.log('✅ Connected to MQTT broker');
    document.getElementById('loadingIndicator').classList.remove('active');
    updateConnectionStatus(true);
    client.subscribe([CHAT_TOPIC, PRESENCE_TOPIC, TYPING_TOPIC], { qos: 1 });
    if (DEBUG_MODE) console.log('Subscribed to topics:', [CHAT_TOPIC, PRESENCE_TOPIC, TYPING_TOPIC]);
    publishPresence('online');
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('chatInterface').classList.add('active');
    addSystemMessage('Connected to AADAmeet ✓');
    showToast('Connected successfully', 'success');
    setTimeout(() => publishPresence('online'), 500);
  }

  function handleMessage(topic, payload) {
    try {
      const data = JSON.parse(payload.toString());
      if (DEBUG_MODE) console.log('Message on', topic, data);
      if (topic === CHAT_TOPIC) handleChatMessage(data);
      else if (topic === PRESENCE_TOPIC) handlePresence(data);
      else if (topic === TYPING_TOPIC) handleTypingIndicator(data);
    } catch (error) {
      console.error('Error handling message:', error);
    }
  }

  function handleChatMessage(data) {
    if (data.userId === currentUser.id) return;
    addMessage(data);
    if (notificationsEnabled && document.hidden) showNotification(data.name, data.message);
    playMessageSound();
  }

  function handlePresence(data) {
    if (data.userId === currentUser.id) return;
    if (data.status === 'online') {
      users.set(data.userId, {
        id: data.userId,
        name: data.name,
        avatar: data.name.charAt(0).toUpperCase(),
        color: generateColor(data.name),
        online: true
      });
      addSystemMessage(`${data.name} joined`);
    } else if (data.status === 'offline') {
      const user = users.get(data.userId);
      if (user) {
        user.online = false;
        addSystemMessage(`${data.name} left`);
      }
    }
    updateUserList();
  }

  function handleTypingIndicator(data) {
    if (data.userId === currentUser.id) return;
    if (data.typing) typingUsers.add(data.userId);
    else typingUsers.delete(data.userId);
    updateTypingIndicator();
  }

  function handleError(error) {
    console.error('❌ MQTT Error:', error);
    document.getElementById('loadingIndicator').classList.remove('active');
    const loginBtn = document.getElementById('loginBtn');
    loginBtn.disabled = false;
    loginBtn.textContent = 'Connect';
    let msg = 'Connection error.';
    if (error.message && error.message.includes('Connection refused')) msg = 'Invalid credentials or broker URL.';
    else if (error.message && error.message.includes('timeout')) msg = 'Connection timeout. Check broker URL.';
    else msg += ' Check console for details.';
    showToast(msg, 'error');
  }

  function handleOffline() {
    if (DEBUG_MODE) console.log('⚠️ Connection lost');
    updateConnectionStatus(false);
    showToast('Connection lost. Reconnecting...', 'error');
  }

  function handleReconnect() {
    if (DEBUG_MODE) console.log('🔄 Reconnecting...');
    showToast('Reconnecting...', 'error');
  }

  // ── MESSAGING ──────────────────────────────────
  document.getElementById('sendBtn').addEventListener('click', sendMessage);

  document.getElementById('messageInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  document.getElementById('messageInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    document.getElementById('charCounter').textContent = this.value.length || '';
    const container = document.getElementById('messagesContainer');
    setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
    handleTyping();
  });

  document.getElementById('messageInput').addEventListener('focus', function() {
    setTimeout(() => {
      const container = document.getElementById('messagesContainer');
      container.scrollTop = container.scrollHeight;
      if (window.innerWidth <= 768) this.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 300);
  });

  function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message || !client || !client.connected) {
      if (!client || !client.connected) showToast('Not connected. Please wait...', 'error');
      return;
    }
    const payload = {
      userId: currentUser.id,
      name: currentUser.name,
      avatar: currentUser.avatar,
      color: currentUser.color,
      message,
      timestamp: Date.now()
    };
    client.publish(CHAT_TOPIC, JSON.stringify(payload), { qos: 1 });
    addMessage(payload, true);
    input.value = '';
    input.style.height = 'auto';
    document.getElementById('charCounter').textContent = '';

    const sendBtn = document.getElementById('sendBtn');
    sendBtn.style.transform = 'scale(0.85)';
    setTimeout(() => { sendBtn.style.transform = ''; }, 150);

    publishTyping(false);
    const container = document.getElementById('messagesContainer');
    setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
  }

  function handleTyping() {
    if (!client || !client.connected) return;
    publishTyping(true);
    if (typingTimeout) clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => publishTyping(false), 3000);
  }

  function publishTyping(isTyping) {
    if (!client || !client.connected) return;
    client.publish(TYPING_TOPIC, JSON.stringify({
      userId: currentUser.id, name: currentUser.name, typing: isTyping, timestamp: Date.now()
    }), { qos: 0 });
  }

  function updateTypingIndicator() {
    const container = document.getElementById('messagesContainer');
    container.querySelector('.typing-indicator')?.remove();
    if (typingUsers.size > 0) {
      const userId = Array.from(typingUsers)[0];
      const user = users.get(userId);
      if (user) {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = `
          <div class="message-avatar" style="background:${user.color}">${user.avatar}</div>
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>`;
        container.appendChild(typingDiv);
        container.scrollTop = container.scrollHeight;
      }
    }
  }

  function publishPresence(status) {
    if (!client || !client.connected || !currentUser) return;
    client.publish(PRESENCE_TOPIC, JSON.stringify({
      userId: currentUser.id, name: currentUser.name, status, timestamp: Date.now()
    }), { qos: 1, retain: true });
  }

  // ── LINK MODAL ─────────────────────────────────
  function showLinkModal(url) {
    const modal = document.getElementById('linkModal');
    const body = document.getElementById('linkModalBody');
    modal.classList.add('active');
    body.innerHTML = `
      <div class="link-url">${escapeHtml(url)}</div>
      <div class="link-modal-checking">
        <div class="loading-spinner sm"></div>
        <p style="margin-top:12px">Checking link safety...</p>
        <div class="link-being-checked">${escapeHtml(url)}</div>
      </div>`;
    checkLinkSafety(url);
  }

  function closeLinkModal() {
    document.getElementById('linkModal').classList.remove('active');
  }

  function openLinkDirectly(url) {
    window.open(url, '_blank', 'noopener,noreferrer');
    closeLinkModal();
  }

  async function checkLinkSafety(url) {
    const body = document.getElementById('linkModalBody');
    try {
      const isValid = /^https?:\/\/.+/.test(url);
      if (!isValid) {
        displayLinkResult(url, { status: 'invalid' });
        return;
      }
      const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoint}`, {
        method: API_CONFIG.method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      displayLinkResult(url, data);
    } catch (error) {
      console.error('Link check error:', error);
      body.innerHTML = `
        <div class="link-url">${escapeHtml(url)}</div>
        <div class="link-modal-actions">
          <button class="link-modal-btn secondary" id="cancelDirectBtn">
            <span class="material-icons">close</span><span>Cancel</span>
          </button>
          <button class="link-modal-btn primary" id="openDirectBtn">
            <span class="material-icons">open_in_new</span><span>Open Anyway</span>
          </button>
        </div>`;
      document.getElementById('cancelDirectBtn').addEventListener('click', closeLinkModal);
      document.getElementById('openDirectBtn').addEventListener('click', () => openLinkDirectly(url));
      showToast('Could not verify link safety', 'error');
    }
  }

  function displayLinkResult(url, data) {
    const body = document.getElementById('linkModalBody');
    const stats = data.stats || null;
    const isSafe = data.status === 'safe' || data.status === 'clean';

    if (isSafe) {
      body.innerHTML = `
        <div class="link-url">${escapeHtml(url)}</div>
        <div class="link-result safe">
          <span class="material-icons">verified_user</span>
          <div class="link-result-content">
            <h4>Link appears safe</h4>
            <p>No threats detected by our security check.</p>
            ${stats ? `<div class="link-result-stats">
              <div class="link-result-stat clean"><span class="material-icons">check_circle</span><span>${stats.harmless || 0} Clean</span></div>
              <div class="link-result-stat"><span class="material-icons">shield</span><span>${stats.undetected || 0} Undetected</span></div>
            </div>` : ''}
          </div>
        </div>
        <div class="link-modal-actions">
          <button class="link-modal-btn secondary" id="cancelSafeBtn"><span class="material-icons">close</span><span>Cancel</span></button>
          <button class="link-modal-btn primary" id="openSafeBtn"><span class="material-icons">open_in_new</span><span>Open Link</span></button>
        </div>`;
      document.getElementById('cancelSafeBtn').addEventListener('click', closeLinkModal);
      document.getElementById('openSafeBtn').addEventListener('click', () => openLinkDirectly(url));
      showToast('Link verified safe', 'success');
    } else {
      body.innerHTML = `
        <div class="link-url">${escapeHtml(url)}</div>
        <div class="link-result unsafe">
          <span class="material-icons">warning</span>
          <div class="link-result-content">
            <h4>Warning: Potentially Unsafe</h4>
            <p>${data.status === 'invalid' ? 'This link has an invalid format.' : 'This link may be unsafe to open.'}</p>
            ${stats ? `<div class="link-result-stats">
              <div class="link-result-stat malicious"><span class="material-icons">dangerous</span><span>${stats.malicious || 0} Malicious</span></div>
              <div class="link-result-stat"><span class="material-icons">warning</span><span>${stats.suspicious || 0} Suspicious</span></div>
            </div>` : ''}
          </div>
        </div>
        <div class="link-modal-actions">
          <button class="link-modal-btn primary" id="closeUnsafeBtn"><span class="material-icons">close</span><span>Close</span></button>
        </div>`;
      document.getElementById('closeUnsafeBtn').addEventListener('click', closeLinkModal);
      showToast('Link flagged as unsafe!', 'error');
    }
  }

  // ── UI CONTROLS ────────────────────────────────
  document.getElementById('menuToggle').addEventListener('click', function() {
    document.getElementById('sidebar').classList.toggle('open');
    this.style.transform = 'scale(0.9)';
    setTimeout(() => { this.style.transform = ''; }, 100);
  });

  document.getElementById('clearBtn').addEventListener('click', function() {
    if (confirm('Clear all messages?')) {
      document.getElementById('messagesContainer').innerHTML = '';
      lastSenderId = null;
      addSystemMessage('Chat cleared');
      showToast('Chat history cleared', 'success');
    }
  });

  document.getElementById('rememberMeBtn').addEventListener('click', function() {
    if (isRememberMeEnabled()) {
      clearSavedCredentials();
      showToast('Remember Me disabled', 'info');
    } else {
      if (currentUser) {
        const u = localStorage.getItem('savedUsername') || '';
        const p = localStorage.getItem('savedPassword') || '';
        saveCredentials(currentUser.name, u, p);
      }
      showToast('Remember Me enabled', 'success');
    }
    updateRememberMeIcon();
    this.style.transform = 'scale(0.9)';
    setTimeout(() => { this.style.transform = ''; }, 100);
  });

  document.getElementById('notifBtn').addEventListener('click', function() {
    notificationsEnabled = !notificationsEnabled;
    const icon = document.getElementById('notifIcon');
    icon.textContent = notificationsEnabled ? 'notifications' : 'notifications_off';
    this.style.color = notificationsEnabled ? '' : 'var(--red)';
    showToast(`Notifications ${notificationsEnabled ? 'enabled' : 'disabled'}`, 'success');
    this.style.transform = 'scale(0.9)';
    setTimeout(() => { this.style.transform = ''; }, 100);
  });

  function showNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification(title, { body });
    }
  }

  function playMessageSound() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = 880;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.06, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.15);
    } catch (e) { /* silent */ }
  }

  // Close sidebar on outside click (mobile)
  document.addEventListener('click', e => {
    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('menuToggle');
    if (window.innerWidth <= 768 && sidebar.classList.contains('open') &&
        !sidebar.contains(e.target) && !toggle.contains(e.target)) {
      sidebar.classList.remove('open');
    }
  });

  // Link modal controls
  document.getElementById('linkModalClose').addEventListener('click', closeLinkModal);
  document.getElementById('linkModal').addEventListener('click', function(e) {
    if (e.target === this) closeLinkModal();
  });

  // Preview panel controls
  document.getElementById('closePreviewBtn').addEventListener('click', () => {
    document.getElementById('codePreviewPanel').classList.remove('active');
  });
  document.getElementById('clearPreviewBtn').addEventListener('click', () => {
    document.getElementById('previewIframe').srcdoc = '';
    showToast('Preview cleared', 'info');
  });

  // Preview resize
  const previewPanel = document.getElementById('codePreviewPanel');
  const resizeHandle = document.getElementById('previewResizeHandle');
  let isResizing = false, startY = 0, startHeight = 0;

  resizeHandle.addEventListener('mousedown', e => {
    isResizing = true; startY = e.clientY; startHeight = previewPanel.offsetHeight;
    document.body.style.cursor = 'ns-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });

  resizeHandle.addEventListener('touchstart', e => {
    isResizing = true; startY = e.touches[0].clientY; startHeight = previewPanel.offsetHeight;
    e.preventDefault();
  }, { passive: false });

  document.addEventListener('mousemove', e => {
    if (!isResizing) return;
    const newH = Math.max(200, Math.min(startHeight + (startY - e.clientY), window.innerHeight * 0.8));
    previewPanel.style.height = newH + 'px';
  });

  document.addEventListener('touchmove', e => {
    if (!isResizing) return;
    const newH = Math.max(150, Math.min(startHeight + (startY - e.touches[0].clientY), window.innerHeight * 0.7));
    previewPanel.style.height = newH + 'px';
  }, { passive: false });

  document.addEventListener('mouseup', () => {
    if (isResizing) { isResizing = false; document.body.style.cursor = ''; document.body.style.userSelect = ''; }
  });

  document.addEventListener('touchend', () => { if (isResizing) isResizing = false; });

  // Notifications
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }

  // Visibility change
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && client && client.connected) publishPresence('online');
  });

  // Unload cleanup
  window.addEventListener('beforeunload', () => {
    if (client && client.connected) { publishPresence('offline'); client.end(); }
  });

  // Resize handler
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      const container = document.querySelector('.container');
      if (container) container.style.height = window.innerHeight + 'px';
      const mc = document.getElementById('messagesContainer');
      if (mc && document.getElementById('chatInterface').classList.contains('active')) {
        mc.scrollTop = mc.scrollHeight;
      }
    }, 100);
  });

  if (window.innerWidth <= 768) {
    const container = document.querySelector('.container');
    if (container) container.style.height = window.innerHeight + 'px';
  }

  // Prevent double-tap zoom
  let lastTouch = 0;
  document.addEventListener('touchend', e => {
    const now = Date.now();
    if (now - lastTouch <= 300) e.preventDefault();
    lastTouch = now;
  }, { passive: false });

  console.log('✅ AADAmeet ready');
});
</script>
</body>
</html>
